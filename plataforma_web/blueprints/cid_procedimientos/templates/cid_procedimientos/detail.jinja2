{% extends 'layouts/app.jinja2' %}
{% import 'macros/detail.jinja2' as detail %}
{% import 'macros/modals.jinja2' as modals %}
{% import 'macros/topbar.jinja2' as topbar %}
{% import 'macros/accordion.jinja2' as accordion %}

{% block title %}Procedimiento{% endblock %}

{% block custom_head %}
    <style>
    .bg-yellow {
        color: rgb(6, 6, 6);
        background-color: #f3ebb3;
    }
    .bg-blue {
        color: rgb(42, 42, 42);
        background-color: #7ebdf7;
    }
    .bg-green {
        color: rgb(37, 37, 37);
        background-color: #64cb90;
    }
    </style>
{% endblock %}

{% block topbar_actions %}
    {% call topbar.page_buttons('Procedimiento') %}
        {{ topbar.button_previous('Procedimientos', url_for('cid_procedimientos.list_active')) }}
        {% if show_button_cambiar_area %}
            {{ topbar.button_edit('Editar Área', url_for('cid_procedimientos.cambiar_area', cid_procedimiento_id=cid_procedimiento.id)) }}
        {% endif %}
        {# {% if show_button_edit_admin %}
            {{ topbar.button_edit('Editar Autoridad', url_for('cid_procedimientos.edit_admin', cid_procedimiento_id=cid_procedimiento.id)) }}
        {% endif %} #}
        {% if current_user.can_edit('CID PROCEDIMIENTOS') %}
            {% if not cid_procedimiento.firma %}
                {{ topbar.button_edit('Editar', url_for('cid_procedimientos.edit', cid_procedimiento_id=cid_procedimiento.id)) }}
                {% if current_user.id == cid_procedimiento.usuario_id %}
                    {{ topbar.button_make('Firmar', url_for('cid_procedimientos.sign_for_maker', cid_procedimiento_id=cid_procedimiento.id)) }}
                {% endif %}
            {% endif %}
        {% endif %}
        {% if current_user.can_admin('CID PROCEDIMIENTOS') %}
            {% if cid_procedimiento.estatus == 'A' %}{{ topbar.button_delete('Eliminar', url_for('cid_procedimientos.delete', cid_procedimiento_id=cid_procedimiento.id)) }}{% endif %}
            {% if cid_procedimiento.estatus == 'B' %}{{ topbar.button_recover('Recuperar', url_for('cid_procedimientos.recover', cid_procedimiento_id=cid_procedimiento.id)) }}{% endif %}
        {% endif %}
        {% if current_user.can_insert('CID FORMATOS') %}
            {{ topbar.button_new('Agregar formato', url_for('cid_formatos.new', cid_procedimiento_id=cid_procedimiento.id)) }}
        {% endif %}
    {% endcall %}
{% endblock %}

{% block content %}
    {% set accordion_id = 'procedimiento_accordion' %}
    {% call accordion.div(accordion_id, estatus=cid_procedimiento.estatus) %}
        {% call accordion.item('generales_item', 'Generales', accordion_id, expanded=True, estatus=cid_procedimiento.estatus) %}
            {{ detail.label_value('ID', cid_procedimiento.id) }}
            {{ detail.label_value('Título', cid_procedimiento.titulo_procedimiento) }}
            {{ detail.label_value('Código', cid_procedimiento.codigo) }}
            {{ detail.label_value('Revisión', cid_procedimiento.revision) }}
            {{ detail.label_value('Fecha', cid_procedimiento.fecha) }}
            <div class="row">
                <div class="col-md-3 text-end">Seguimiento</div>
                <div class="col-md-9">
                    {% if cid_procedimiento.seguimiento == "EN ELABORACION" %}
                        <span class="badge rounded-pill bg-yellow">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:account-edit"></span></span>
                    {% elif cid_procedimiento.seguimiento == "ELABORADO" %}
                        <span class="badge rounded-pill bg-warning text-dark">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:account-check"></span></span>
                    {% elif cid_procedimiento.seguimiento == "EN REVISION" %}
                        <span class="badge rounded-pill bg-blue">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:account-search"></span></span>
                    {% elif cid_procedimiento.seguimiento == "REVISADO" %}
                        <span class="badge rounded-pill bg-primary">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:file-check"></span></span>
                    {% elif cid_procedimiento.seguimiento == "EN AUTORIZACION" %}
                        <span class="badge rounded-pill bg-green">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:file-document-check"></span></span>
                    {% elif cid_procedimiento.seguimiento == "AUTORIZADO" %}
                        <span class="badge rounded-pill bg-success">{{ cid_procedimiento.seguimiento }} <span class="iconify" data-icon="mdi:shield-check"></span></span>
                    {% else %}
                        <strong>{{ cid_procedimiento.seguimiento }}</strong>
                    {% endif %}
                </div>
            </div>
                <div class="row">
                <div class="col-md-3 text-end">Seguimiento posterior</div>
                <div class="col-md-9">
                    {% if cid_procedimiento.seguimiento_posterior == "EN ELABORACION" %}
                        <span class="badge rounded-pill bg-yellow">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:account-edit"></span></span>
                    {% elif cid_procedimiento.seguimiento_posterior == "ELABORADO" %}
                        <span class="badge rounded-pill bg-warning text-dark">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:account-check"></span></span>
                    {% elif cid_procedimiento.seguimiento_posterior == "EN REVISION" %}
                        <span class="badge rounded-pill bg-blue">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:account-search"></span></span>
                    {% elif cid_procedimiento.seguimiento_posterior == "REVISADO" %}
                        <span class="badge rounded-pill bg-primary">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:file-check"></span></span>
                    {% elif cid_procedimiento.seguimiento_posterior == "EN AUTORIZACION" %}
                        <span class="badge rounded-pill bg-green">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:file-document-check"></span></span>
                    {% elif cid_procedimiento.seguimiento_posterior == "AUTORIZADO" %}
                        <span class="badge rounded-pill bg-success">{{ cid_procedimiento.seguimiento_posterior }} <span class="iconify" data-icon="mdi:shield-check"></span></span>
                    {% else %}
                        <strong>{{ cid_procedimiento.seguimiento_posterior }}</strong>
                    {% endif %}
                </div>
            </div>
            {{ detail.label_value('Usuario', cid_procedimiento.usuario.nombre) }}
            {{ detail.label_value('Firma guardada', cid_procedimiento.firma) }}
            {{ detail.label_value('Firma al vuelo', firma_al_vuelo) }}
            {{ detail.label_value_new_tab('Archivo PDF', cid_procedimiento.archivo, cid_procedimiento.url) }}
            {{ detail.label_value('Distrito', cid_procedimiento.autoridad.distrito.nombre_corto) }}
            {{ detail.label_value('Autoridad', cid_procedimiento.autoridad.descripcion_corta) }}
            {% if current_user.can_view('CID AREAS') %}
                {{ detail.label_value('Área', cid_procedimiento.cid_area.nombre, url_for('cid_areas.detail', cid_area_id=cid_procedimiento.cid_area_id)) }}
            {% else %}
                {{ detail.label_value('Área', cid_procedimiento.cid_area.nombre) }}
            {% endif %}
        {% endcall %}
        {% call accordion.item('objetivos_item', 'Objetivo', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ objetivo }}
        {% endcall %}
        {% call accordion.item('alcance_item', 'Alcance', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ alcance }}
        {% endcall %}
        {% call accordion.item('documentos_item', 'Documentos de Referencia', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ documentos }}
        {% endcall %}
        {% call accordion.item('definiciones_item', 'Definiciones', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ definiciones }}
        {% endcall %}
        {% call accordion.item('responsabilidades_item', 'Responsabilidades', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ responsabilidades }}
        {% endcall %}
        {% call accordion.item('desarrollo_item', 'Desarrollo', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ desarrollo }}
        {% endcall %}
         <!-- Registros -->
        {% call accordion.item('registro_item', 'Registros', accordion_id, estatus=cid_procedimiento.estatus) %}
                <table id="registro_dataTable1_detail" class="table table-striped responsive" width="100%">
                    <thead>
                        <th>Código</th>
                        <th>Nombre registro</th>
                        <th>Responsable</th>
                        <th>Años de retención</th>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
        {% endcall %}
        {% call accordion.item('control_cambios_item', 'Control de Cambios', accordion_id, estatus=cid_procedimiento.estatus) %}
            <table id="control_dataTable1_detail" class="table table-striped responsive" width="100%">
                    <thead>
                        <th>No. Revisión</th>
                        <th>Cambios y/o Actualizaciónes</th>
                        <th>Solicitud de cambio No.</th>
                        <th>Fecha</th>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
        {% endcall %}
        {% call accordion.item('autorizaciones', 'Autorizaciones', accordion_id, estatus=cid_procedimiento.estatus) %}
            {{ detail.label_value('Elaboró nombre', cid_procedimiento.elaboro_nombre) }}
            {{ detail.label_value('Elaboró puesto', cid_procedimiento.elaboro_puesto) }}
            {{ detail.label_value('Elaboró correo', cid_procedimiento.elaboro_email) }}
            {{ detail.label_value('Revisó nombre', cid_procedimiento.reviso_nombre) }}
            {{ detail.label_value('Revisó puesto', cid_procedimiento.reviso_puesto) }}
            {{ detail.label_value('Revisó correo', cid_procedimiento.reviso_email) }}
            {{ detail.label_value('Autorizó nombre', cid_procedimiento.aprobo_nombre) }}
            {{ detail.label_value('Autorizó puesto', cid_procedimiento.aprobo_puesto) }}
            {{ detail.label_value('Autorizó correo', cid_procedimiento.aprobo_email) }}
        {% endcall %}
    {% endcall %}
    {% if cid_procedimiento.formatos|length > 0 %}
        {% call detail.card(title='Formatos') %}
            <table id="formatos_datatable" class="table display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Descripciones</th>
                        <th>URLs</th>
                    </tr>
                </thead>
                <tbody>
                {% for cid_formato in cid_procedimiento.formatos %}
                    {% if cid_formato.estatus == "A" %}
                    <tr>
                        <td><a href="{{ url_for('cid_formatos.detail', cid_formato_id=cid_formato.id) }}">{{ cid_formato.descripcion }}</a></td>
                        <td><a href="{{ cid_formato.url }}" target="_blank">Abrir</a></td>
                    </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        {% endcall %}
    {% endif %}
{% endblock %}

{% block custom_javascript %}
    {% if current_user.can_edit('CID PROCEDIMIENTOS') %}
        {% if cid_procedimiento.estatus == 'A' %}{{ modals.custom_javascript_delete('Eliminar', '¿Eliminar a ' + cid_procedimiento.titulo_procedimiento + '?') }}{% endif %}
        {% if cid_procedimiento.estatus == 'B' %}{{ modals.custom_javascript_recover('Recuperar', '¿Recuperar a ' + cid_procedimiento.titulo_procedimiento + '?') }}{% endif %}
        {{ modals.custom_javascript_make('Firmar', '¿Está seguro de que quiere firmarlo? Ya no podrá cambiarlo después.') }}
    {% endif %}
    <!-- Detalle Registros -->
    <script>
        let datos = {{ registros }};
        $(document).ready(function(){
            var Arrayfinal = [];
            Object.keys(datos).forEach(item =>{
                var tempArr = new Array();
                datos[item].forEach(a => {
                    tempArr.push(a);
                });
                Arrayfinal.push(tempArr);
            });

            $("#registro_dataTable1_detail").DataTable({
                data:Arrayfinal
            });
        });
    </script>
     <!-- Detalle Control de cambios -->
    <script>
        let datos_cambio = {{ control_cambios }};
        $(document).ready(function(){
            var Arrayfinal = [];
            Object.keys(datos_cambio).forEach(item =>{
                var tempArr = new Array();
                datos_cambio[item].forEach(a => {
                    tempArr.push(a);
                });
                Arrayfinal.push(tempArr);
            });

            $("#control_dataTable1_detail").DataTable({
                data:Arrayfinal
            });
        });
    </script>
{% endblock %}
