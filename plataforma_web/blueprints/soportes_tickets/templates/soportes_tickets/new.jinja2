{% extends 'layouts/app.jinja2' %}
{% import 'macros/form.jinja2' as f with context %}
{% import 'macros/topbar.jinja2' as topbar %}
{% import 'macros/list.jinja2' as list %}

{% block title %}Nuevo Ticket{% endblock %}

{% block custom_head %}
    <style>
        .radiobutton_inline {
            display: flex;
        }
    </style>
{% endblock %}

{% block topbar_actions %}
    {{ topbar.page('Nuevo Ticket') }}
{% endblock %}

{% block content %}
    {% call f.card() %}
        {% call f.form_tag('soportes_tickets.new', fid='soporte_tickets_form') %}
            {% call f.form_group(form.usuario, readonly=true) %}{% endcall %}
            {% call f.form_group(form.descripcion, rows=7) %}{% endcall %}
            {% call f.form_group(form.clasificacion, css_class="radiobutton_inline") %}{% endcall %}
            {% call f.form_group(form.guardar) %}{% endcall %}
        {% endcall %}
    {% endcall %}
    {% if current_user.can_view("SOPORTES CATEGORIAS") %}
        <p>* Antes de enviar un ticket, lea las instrucciones del tipo de problema que presenta, y redacte conforme a las indicacciones descritas.</p>
        <p>Para los ticket´s que se dirigen a los sistemas de gestión SIGE y PAIIJ que no abarque una categoría, es necesario enviar un oficio dirigido a la Visitaduría General con copia a la Dirección de Informática, explicando el problema presentado.</p>
        {% call list.card('Instrucciones') %}
            <table id="instrucciones_datatable" class="table display nowrap" style="width:100%;">
                <thead>
                    <tr>
                        <th>Categoría</th>
                        <th>Atendido por</th>
                        <th>Requisitos</th>
                    </tr>
                </thead>
            </table>
        {% endcall %}
    {% endif %}
{% endblock %}

{% block custom_javascript %}
    <script>
        let dataSet = {{ filtros }};
        let tabla_instrucciones = $('#instrucciones_datatable').DataTable({
            processing: true,
            serverSide: true,
            ordering: false,
            searching: false,
            responsive: true,
            scrollX: true,
            ajax: {
                url: "/soportes_categorias/datatable_json",
                type: "POST",
                headers: { "X-CSRF-TOKEN": "{{ csrf_token() }}" },
                dataType: "json",
                dataSrc: "data",
                data: function ( d ) {
                    return  $.extend(d, dataSet);
                }
            },
            columns: [
                { data: "nombre" },
                { data: "atendido" },
                { data: "instrucciones" }
            ],
            columnDefs: [
                {
                    targets: [0],
                    data: null,
                    render: function(data, type, row, meta) {
                        return (data.length > 48 ? data.substr(0, 48) + '…' : data);
                    }
                },
                {
                    targets: [2],
                    data: null,
                    render: function(data, type, row, meta) {
                        return '<a href="' + data.url + '">Leer requisitos</a>';
                    }
                }
            ],
            language: {
                lengthMenu: "Mostrar _MENU_",
                search: "Filtrar:",
                zeroRecords: "No se encontraron registros",
                info: "Total de registros _TOTAL_ ",
                infoEmpty: "No hay registros",
                infoFiltered: "(_TOTAL_ filtrados de _MAX_ registros)",
                oPaginate: {
                    sFirst: "Primero",
                    sLast: "Último",
                    sNext: "Siguiente",
                    sPrevious: "Anterior"
                }
            }
        });

        /* Filtrar el listado según el radibutton seleccionado */
        $('input[type=radio][name=clasificacion]').change(function() {
            dataSet.filtrar_categoria = this.value;
            tabla_instrucciones.ajax.reload();
        });

    </script>
{% endblock %}
