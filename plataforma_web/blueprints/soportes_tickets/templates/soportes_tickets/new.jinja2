{% extends 'layouts/app.jinja2' %}
{% import 'macros/form.jinja2' as f with context %}
{% import 'macros/topbar.jinja2' as topbar %}
{% import 'macros/list.jinja2' as list %}

{% block title %}Nuevo Ticket{% endblock %}

{% block custom_head %}
    <style>
        .radiobutton_inline { display: flex; }
    </style>
{% endblock %}

{% block topbar_actions %}
    {{ topbar.page('Nuevo Ticket') }}
{% endblock %}

{% block content %}
    {% call f.card('IMPORTANTE') %}
        <ul>
            <li>Algunos soportes técnicos pueden necesitar información especifica u oficios para su realización. Lea "Requisitos de las categorías" (tabla inferior).</li>
            <li>Después de dar clic en el botón guardar podrá adjuntar archivos archivos al ticket, como archivos pdf de los oficios o imágenes de evidencia.</li>
            <li>Los soportes técnicos de los sistemas de gestión SIGE y PAIIJ que no sean parte de una categoría, necesitan oficio dirigido a la Visitaduría General con copia a la Dirección de Informática explicando el problema presentado y quedan en proceso de la autorización correspondiente.</li>
        </ul>
    {% endcall %}
    {% call f.card('Nuevo Ticket') %}
        {% call f.form_tag('soportes_tickets.new', fid='soporte_tickets_form') %}
            {% call f.form_group(form.usuario, readonly=true) %}{% endcall %}
            {% call f.form_group(form.oficina, readonly=true) %}{% endcall %}
            {% call f.form_group(form.descripcion, rows=7) %}{% endcall %}
            {% call f.form_group(form.clasificacion, css_class="radiobutton_inline") %}{% endcall %}
            {% call f.form_group(form.guardar) %}{% endcall %}
        {% endcall %}
    {% endcall %}
    {% call f.card('Requisitos de las categorías') %}
        <table id="soportes_categorias_datatable" class="table display nowrap" style="width:100%;">
            <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Requisitos</th>
                </tr>
            </thead>
        </table>
    {% endcall %}
{% endblock %}

{% block custom_javascript %}
    <script>
        let dataSet = {{ filtros }};
        let soportes_categorias_ajax = $('#soportes_categorias_datatable').DataTable({
            processing: true,
            serverSide: true,
            ordering: false,
            searching: false,
            responsive: true,
            scrollX: true,
            ajax: {
                url: "/soportes_categorias/datatable_json",
                type: "POST",
                headers: { "X-CSRF-TOKEN": "{{ csrf_token() }}" },
                dataType: "json",
                dataSrc: "data",
                data: function ( d ) {
                    return $.extend(d, dataSet);
                }
            },
            columns: [
                { data: "detalle" },
                { data: "instrucciones" }
            ],
            columnDefs: [
                {
                    targets: 0,
                    data: null,
                    render: function(data, type, row, meta) {
                        if (data.nombre.length > 48) {
                            return '<a href="' + data.url + '" target="_blank">' + data.nombre.substr(0, 48) + '… </a>';
                        } else {
                            return '<a href="' + data.url + '" target="_blank">' + data.nombre + '</a>';
                        }
                    }
                },
                {
                    targets: 1,
                    data: null,
                    render: function(data, type, row, meta) {
                        if (data != null)
                            if (data.length > 48) {
                                return '<span title="' + data + '">' + data.substr(0, 48) + '…</span>';
                            } else {
                                return data;
                            }
                        return '—';
                    }
                }
            ],
            language: {
                lengthMenu: "Mostrar _MENU_",
                search: "Filtrar:",
                zeroRecords: "No se encontraron registros",
                info: "Total de registros _TOTAL_ ",
                infoEmpty: "No hay registros",
                infoFiltered: "(_TOTAL_ filtrados de _MAX_ registros)",
                oPaginate: {
                    sFirst: "Primero",
                    sLast: "Último",
                    sNext: "Siguiente",
                    sPrevious: "Anterior"
                }
            }
        });

        /* Filtrar el listado según el radibutton seleccionado */
        $('input[type=radio][name=clasificacion]').change(function() {
            dataSet.nombre = this.value;
            soportes_categorias_ajax.ajax.reload();
        });

    </script>
{% endblock %}
